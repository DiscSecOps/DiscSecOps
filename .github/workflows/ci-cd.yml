name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
 
  # Backend CI/CD Job
  backend-ci:
    name: Backend CI
    runs-on: ubuntu-latest
        
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Sets up Python 3.12 + uv + Caching automatically
      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          python-version: "3.12"
          enable-cache: true
          cache-dependency-glob: "backend/uv.lock"

      - name: Install Backend Dependencies
        run: make install-backend

      - name: Lint & Format (Ruff + Mypy)
        run: make lint-backend

      - name: Security Scan (Bandit + Safety)
        run: make security-backend

      - name: Run Tests
        run: make test-backend
    
    # Uncomment when ready to build Docker image
    # - name: Build Docker image
    #   run: docker build -t backend-app .


  # Frontend CI Job (Unit Tests)
  frontend-ci:
    name: Frontend CI
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Frontend Dependencies
        run: cd frontend && npm ci

      - name: Run Unit Tests (Vitest)
        run: make test-frontend-unit

  e2e-tests:
    name: E2E Tests (Playwright)
    runs-on: ubuntu-latest
    services:
      db:
        image: postgres:15
        env:
          POSTGRES_USER: user
          POSTGRES_PASSWORD: password
          POSTGRES_DB: app_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- Backend Setup ---
      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          python-version: "3.12"
          enable-cache: true
          cache-dependency-glob: "backend/uv.lock"

      - name: Install Backend Dependencies
        run: cd backend && uv sync

      - name: Setup Test Database
        env:
          DATABASE_URL: postgresql+asyncpg://user:password@localhost:5432/app_db
        run: |
          cd backend
          uv run alembic upgrade head
          uv run python scripts/create_test_users.py

      - name: Start Backend
        env:
          DATABASE_URL: postgresql+asyncpg://user:password@localhost:5432/app_db
        run: |
          cd backend
          uv run uvicorn app.main:app --host 0.0.0.0 --port 5000 &
          echo "Waiting for backend to start..."
          sleep 10

      # --- Frontend Setup ---
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "frontend/package-lock.json"

      - name: Install Frontend Dependencies
        run: cd frontend && npm ci

      - name: Install Playwright Browsers
        run: cd frontend && npx playwright install --with-deps

      - name: Run Authentication Tests
        env:
          BASE_URL: http://localhost:5000
        run: |
          cd frontend
          npm run test:e2e -- --grep "@auth"
  #   name: Deploy
  #   needs: [frontend-ci, backend-ci]
  #   runs-on: ubuntu-latest
  #   if: github.ref == 'refs/heads/main'
  #   
  #   steps:
  #   - name: Deploy to production
  #     run: echo "Deploy to your hosting platform"
